# Healthcare Prediction Model with Explainable AI

A machine learning project that predicts hospitalization risk using the MEPS (Medical Expenditure Panel Survey) dataset, with a focus on model explainability and fairness analysis. The project includes a Jupyter notebook for model training and a Streamlit web app for interactive predictions and explanations.

## Project Overview

This project builds a predictive model to estimate hospitalization risk based on demographic, socioeconomic, and health status features. The model uses gradient boosting (LightGBM) and provides real-time SHAP explanations to help users understand how different factors influence predictions.

### Key Components

1. **`1_analysis.ipynb`** - Complete data processing, model training, evaluation, and explainability analysis
2. **`app.py`** - Interactive Streamlit web application for making predictions and exploring model behavior

## Dataset

The project uses the **MEPS 2023 Full Year Consolidated Data File (PUF Number: HC251)** from the Medical Expenditure Panel Survey.

- **Data Source**: [MEPS Official Website](https://meps.ahrq.gov/mepsweb/data_stats/download_data_files.jsp)
- **Alternative Download**: [Google Sheets Link](https://docs.google.com/spreadsheets/d/1N9di-8jFzqyF79VKopojHTmIvPyIoh9p/edit?usp=drive_link)

The dataset includes:
- Demographics: age, sex, race/ethnicity
- Socioeconomic: income, education, poverty level, region
- Health status: chronic conditions (hypertension, diabetes, asthma), smoking status
- Insurance coverage
- Healthcare utilization: inpatient expenditures (used as target variable)

## Installation

### Prerequisites

- Python 3.8 or higher
- pip package manager

### Setup

1. Clone or download this repository

2. Install required packages:
```bash
pip install -r requirements.txt
```

Key dependencies:
- `streamlit` - Web app framework
- `pandas`, `numpy`, `polars` - Data processing
- `lightgbm`, `xgboost` - Gradient boosting models
- `shap` - Model explainability
- `scikit-learn` - Machine learning utilities
- `plotly`, `matplotlib` - Visualization
- `joblib` - Model serialization
- `openpyxl` - Excel file reading

## Usage

### Running the Analysis Notebook

1. Open `1_analysis.ipynb` in Jupyter Notebook or JupyterLab

2. The notebook includes:
   - **Data Loading & Cleaning**: Handling MEPS special codes, missing values
   - **Feature Engineering**: Variable renaming, one-hot encoding, target variable creation
   - **Model Training**: LightGBM and XGBoost with stratified cross-validation
   - **Model Evaluation**: ROC-AUC, precision, recall, F1-score, confusion matrix
   - **Explainability**: SHAP values, permutation importance, local explanations
   - **Model Export**: Saves trained model and artifacts for the Streamlit app

3. Run all cells to:
   - Train the final model
   - Generate SHAP explainer
   - Save model artifacts to `fairness_artifacts/` and `fairness_results/` directories

### Running the Streamlit App

1. Start the app:
```bash
streamlit run app.py
```

2. The app will open in your browser at `http://localhost:8501`

## App Features

The Streamlit app provides an interactive interface for exploring model predictions:

### Step 1: Model Prediction
- Input patient characteristics via sidebar controls
- View predicted hospitalization risk (percentage)
- See risk category (Low/Medium/High)
- Get binary prediction (Hospitalized/Not Hospitalized) based on adjustable threshold

### Step 2: Local SHAP Explanation
- **SHAP Waterfall Plot**: Visual breakdown of how each feature contributes to the prediction
- **Feature Impact**: Top 10 features ranked by their influence
- **Textual Summary**: Plain-language explanation of what's driving the risk up or down

### Step 3: What If? Analysis
- Modify key features (insurance type, sex, age, poverty category, hypertension)
- See how predictions change in real-time
- Compare original vs. modified risk side-by-side

### Step 4: ICE Curve - Age Effect
- Interactive plot showing how predicted risk changes across different ages (0-90)
- Vertical line marking the current patient's age
- Helps visualize the model's age-related patterns

## File Structure

```
.
├── 1_analysis.ipynb          # Main analysis notebook
├── app.py                     # Streamlit web application
├── requirements.txt           # Python dependencies
├── README.md                  # This file
│
├── fairness_artifacts/        # Model and training data (generated by notebook)
│   ├── final_lightgbm_model.pkl
│   ├── X_train.parquet
│   ├── X_test.parquet
│   ├── y_train.parquet
│   └── y_test.parquet
│
└── fairness_results/          # Pre-computed results (generated by notebook)
    ├── shap_explainer.pkl
    └── df_fair_with_shap.parquet
```

## Model Details

### Algorithm
- **Primary Model**: LightGBM (selected after comparing with XGBoost)
- **Performance**: ROC-AUC ~0.74 on test set
- **Training**: Stratified 5-fold cross-validation to handle class imbalance

### Target Variable
- **`hospitalized`**: Binary variable (1 if inpatient expenditures > $0, 0 otherwise)
- Created from `inpatient_expenditures` field in MEPS data

### Features
The model uses 50 features including:
- **Numeric**: age, education_years, family_income, years_in_us
- **Categorical (one-hot encoded)**: sex, race/ethnicity, poverty category, insurance coverage, region, chronic conditions, smoking status

## Explainability

The project uses **SHAP (SHapley Additive exPlanations)** for model interpretability:

- **Global Importance**: Permutation importance to identify most important features overall
- **Local Explanations**: SHAP values for individual predictions showing feature contributions
- **Dependence Plots**: Visualize how specific features affect predictions across their value ranges

## Technical Notes

- The app uses Streamlit's caching (`@st.cache_resource`, `@st.cache_data`) for performance
- Feature vectors must match the exact order expected by the trained model
- SHAP computations are done on-the-fly for real-time explanations
- The model handles missing values using median imputation for numeric features

## References

- **MEPS Dataset**: [AHRQ MEPS Website](https://meps.ahrq.gov/mepsweb/)
- **Model Approach**: Based on research showing gradient boosting effectiveness for healthcare tabular data
- **SHAP Documentation**: [SHAP GitHub](https://github.com/slundberg/shap)

## License

This project is for educational/research purposes. MEPS data usage should comply with AHRQ terms of use.
